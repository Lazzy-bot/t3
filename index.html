<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Farm Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Load E-Ra Widget th·∫≠t -->
  <script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
  <style>
    /* Gi·ªØ nguy√™n style toggle switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 28px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #3b82f6;
    }
    input:checked + .slider:before {
      transform: translateX(22px);
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 p-4 md:p-6">
  <!-- Gi·ªØ nguy√™n HTML UI -->
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center tracking-wide">
      üå± H·ªá Th·ªëng Gi√°m S√°t N√¥ng Tr·∫°i Th√¥ng Minh
    </h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- C·∫£m bi·∫øn -->
      <div class="bg-white rounded-2xl shadow-lg p-5 hover:shadow-xl transition">
        <h2 class="text-xl font-bold text-blue-600 mb-2">Gi√°m S√°t M√¥i Tr∆∞·ªùng</h2>
        <p class="text-sm text-gray-500 mb-4">Theo d√µi th√¥ng s·ªë m√¥i tr∆∞·ªùng theo th·ªùi gian th·ª±c</p>
        <div class="space-y-3">
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <div>
              <p class="text-sm text-gray-500">üå°Ô∏è Nhi·ªát ƒë·ªô</p>
              <p id="temperature" class="text-xl font-semibold">-- ¬∞C</p>
            </div>
          </div>
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <div>
              <p class="text-sm text-gray-500">üíß ƒê·ªô ·∫©m</p>
              <p id="humidity" class="text-xl font-semibold">-- %</p>
            </div>
          </div>
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <div>
              <p class="text-sm text-gray-500">üå± ƒê·ªô ·∫©m ƒë·∫•t</p>
              <p id="soilMoisture" class="text-xl font-semibold">-- %</p>
            </div>
          </div>
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <div>
              <p class="text-sm text-gray-500">üìà Chi·ªÅu cao c√¢y</p>
              <p id="plantHeight" class="text-xl font-semibold">-- cm</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ƒêi·ªÅu khi·ªÉn -->
      <div class="space-y-6">
        <!-- T∆∞·ªõi -->
        <div class="bg-white rounded-2xl shadow-lg p-5 hover:shadow-xl transition">
          <h2 class="text-xl font-bold text-blue-600 mb-2">üí¶ ƒêi·ªÅu Khi·ªÉn T∆∞·ªõi Ti√™u</h2>
          <div class="flex items-center space-x-3 mb-3">
            <span class="text-gray-700 font-medium">Ch·∫ø ƒë·ªô t∆∞·ªõi:</span>
            <label class="switch">
              <input type="checkbox" id="irrigation-switch">
              <span class="slider"></span>
            </label>
            <span id="irrigation-label" class="text-sm text-gray-600">T·ª± ƒë·ªông</span>
          </div>

          <div id="irrigation-manual" class="hidden space-y-3">
            <label class="block text-sm">‚è±Ô∏è Th·ªùi gian t∆∞·ªõi: <span id="irrigation-time" class="font-semibold text-blue-600">10</span> gi√¢y</label>
            <input id="irrigation-duration" type="range" min="5" max="60" step="5" value="10" class="w-full accent-blue-600">
            <button id="btn-irrigate" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg transition">B·∫Øt ƒë·∫ßu t∆∞·ªõi</button>
          </div>

          <div id="irrigation-auto" class="p-3 bg-blue-50 rounded-lg">
            <p class="text-sm text-gray-600">H·ªá th·ªëng t·ª± ƒë·ªông t∆∞·ªõi khi ƒë·∫•t &lt; 40%</p>
          </div>
        </div>

        <!-- Ph√¢n b√≥n -->
        <div class="bg-white rounded-2xl shadow-lg p-5 hover:shadow-xl transition">
          <h2 class="text-xl font-bold text-green-600 mb-2">üåø ƒêi·ªÅu Khi·ªÉn Ph√¢n B√≥n</h2>
          <div class="flex items-center space-x-3 mb-3">
            <span class="text-gray-700 font-medium">Ch·∫ø ƒë·ªô b√≥n:</span>
            <label class="switch">
              <input type="checkbox" id="fertilizer-switch">
              <span class="slider"></span>
            </label>
            <span id="fertilizer-label" class="text-sm text-gray-600">T·ª± ƒë·ªông</span>
          </div>

          <div id="fertilizer-manual" class="hidden space-y-3">
            <label class="block text-sm">Ch·ªçn lo·∫°i ph√¢n:</label>
            <div class="flex space-x-2">
              <button id="btn-nitrogen" class="flex-1 border rounded p-2 hover:bg-green-100">ƒê·∫°m (N)</button>
              <button id="btn-phosphorus" class="flex-1 border rounded p-2 hover:bg-green-100">L√¢n (P)</button>
              <button id="btn-potassium" class="flex-1 border rounded p-2 hover:bg-green-100">Kali (K)</button>
            </div>
            <label class="block text-sm">‚è±Ô∏è Th·ªùi gian b√≥n: <span id="fertilizer-time" class="font-semibold text-green-600">5</span> gi√¢y</label>
            <input id="fertilizer-duration" type="range" min="3" max="20" step="1" value="5" class="w-full accent-green-600">
            <button id="btn-fertilize" class="w-full bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg transition">B√≥n ph√¢n</button>
          </div>

          <div id="fertilizer-auto" class="p-3 bg-green-50 rounded-lg">
            <p class="text-sm text-gray-600">H·ªá th·ªëng t·ª± ƒë·ªông b√≥n ph√¢n theo l·ªãch.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Tr·∫°ng th√°i h·ªá th·ªëng -->
    <div class="bg-white rounded-2xl shadow-lg p-5 mt-6 hover:shadow-xl transition">
      <h2 class="text-xl font-bold text-indigo-600">üì° Tr·∫°ng Th√°i H·ªá Th·ªëng</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
        <div class="flex flex-col items-center p-3 bg-gray-50 rounded-lg">
          <div id="status-irrigation" class="w-4 h-4 rounded-full bg-gray-300 mb-2"></div>
          <span class="text-sm">T∆∞·ªõi ti√™u</span>
        </div>
        <div class="flex flex-col items-center p-3 bg-gray-50 rounded-lg">
          <div id="status-fertilizer" class="w-4 h-4 rounded-full bg-gray-300 mb-2"></div>
          <span class="text-sm">B√≥n ph√¢n</span>
        </div>
        <div class="flex flex-col items-center p-3 bg-gray-50 rounded-lg">
          <div id="status-connection" class="w-4 h-4 rounded-full bg-gray-300 mb-2"></div>
          <span class="text-sm">K·∫øt n·ªëi</span>
        </div>
        <div class="flex flex-col items-center p-3 bg-gray-50 rounded-lg">
          <div id="status-power" class="w-4 h-4 rounded-full bg-gray-300 mb-2"></div>
          <span class="text-sm">Ngu·ªìn ƒëi·ªán</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Kh·ªüi t·∫°o E-Ra th·∫≠t
    const eraWidget = new EraWidget();
    let realtimeConfigs = new Array(4).fill(null);  // 4 sensors (V0-V3)
    let actionConfigs = new Array(9).fill(null);  // 7 controls + 2 durations (V4-V12)
    let isConfigured = false;
    let irrigationMode = "auto";  // M·∫∑c ƒë·ªãnh auto nh∆∞ c≈©
    let fertilizerMode = "auto";  // M·∫∑c ƒë·ªãnh auto nh∆∞ c≈©
    let irrigationDuration = 10;
    let fertilizerDuration = 5;
    let fertilizers = {nitrogen: false, phosphorus: false, potassium: false};

    // Map sensor IDs v√† units
    const sensorMap = ['temperature', 'humidity', 'soilMoisture', 'plantHeight'];
    const sensorUnits = ['¬∞C', '%', '%', 'cm'];

    // Map pin index (V4=0: irrigation, V5=1: irrigate, ..., V10=6: fertilize, V11=7: irrigationDuration, V12=8: fertilizerDuration)
    const pinMap = {
      irrigation: 0,     // V4
      irrigate: 1,       // V5
      fertilizer: 2,     // V6
      nitrogen: 3,       // V7
      phosphorus: 4,     // V8
      potassium: 5,      // V9
      fertilize: 6,      // V10
      irrigationDuration: 7,  // V11 - Bi·∫øn ri√™ng l∆∞u duration t∆∞·ªõi
      fertilizerDuration: 8   // V12 - Bi·∫øn ri√™ng l∆∞u duration b√≥n
    };

    function setIndicator(id, active) {
      const el = document.getElementById(id);
      if (el) el.className = "w-4 h-4 rounded-full mb-2 " + (active ? "bg-green-500" : "bg-gray-300");
    }

    // C·∫≠p nh·∫≠t sensor
    function updateSensorDisplay(sensorIndex, value) {
      if (sensorIndex >= 0 && sensorIndex < sensorMap.length && value !== null && !isNaN(value)) {
        const el = document.getElementById(sensorMap[sensorIndex]);
        if (el) el.textContent = value.toFixed(1) + " " + sensorUnits[sensorIndex];
      }
    }

    // C·∫≠p nh·∫≠t button state (UI only) - Gi·ªØ nguy√™n logic auto/manual nh∆∞ c≈©
    function updateButtonState(buttonId, state) {
      let el;
      switch (buttonId) {
        case 'irrigation':
          el = document.getElementById('irrigation-switch');
          if (el) el.checked = state;
          irrigationMode = state ? "manual" : "auto";
          const irrigationLabelEl = document.getElementById('irrigation-label');
          if (irrigationLabelEl) irrigationLabelEl.textContent = irrigationMode === "auto" ? "T·ª± ƒë·ªông" : "Th·ªß c√¥ng";
          const manualEl = document.getElementById('irrigation-manual');
          const autoEl = document.getElementById('irrigation-auto');
          if (manualEl) manualEl.style.display = state ? 'block' : 'none';
          if (autoEl) autoEl.style.display = !state ? 'block' : 'none';
          // Lu√¥n enable/disable controls d·ª±a tr√™n mode (kh√¥ng ph·ª• thu·ªôc configured)
          const durationInput = document.getElementById('irrigation-duration');
          const btnIrrigate = document.getElementById('btn-irrigate');
          if (durationInput) durationInput.disabled = !state;
          if (btnIrrigate) btnIrrigate.disabled = !state;
          break;
        case 'fertilizer':
          el = document.getElementById('fertilizer-switch');
          if (el) el.checked = state;
          fertilizerMode = state ? "manual" : "auto";
          const fertLabelEl = document.getElementById('fertilizer-label');
          if (fertLabelEl) fertLabelEl.textContent = fertilizerMode === "auto" ? "T·ª± ƒë·ªông" : "Th·ªß c√¥ng";
          const fertManualEl = document.getElementById('fertilizer-manual');
          const fertAutoEl = document.getElementById('fertilizer-auto');
          if (fertManualEl) fertManualEl.style.display = state ? 'block' : 'none';
          if (fertAutoEl) fertAutoEl.style.display = !state ? 'block' : 'none';
          // Lu√¥n enable/disable controls d·ª±a tr√™n mode
          const fertDurationInput = document.getElementById('fertilizer-duration');
          const btnFertN = document.getElementById('btn-nitrogen');
          const btnFertP = document.getElementById('btn-phosphorus');
          const btnFertK = document.getElementById('btn-potassium');
          const btnFertilize = document.getElementById('btn-fertilize');
          if (fertDurationInput) fertDurationInput.disabled = !state;
          if (btnFertN) btnFertN.disabled = !state;
          if (btnFertP) btnFertP.disabled = !state;
          if (btnFertK) btnFertK.disabled = !state;
          if (btnFertilize) btnFertilize.disabled = !state;
          break;
        case 'nitrogen':
        case 'phosphorus':
        case 'potassium':
          el = document.getElementById('btn-' + buttonId);
          if (el) {
            if (state) {
              el.classList.add('bg-green-500', 'text-white');
            } else {
              el.classList.remove('bg-green-500', 'text-white');
            }
          }
          fertilizers[buttonId] = state;
          break;
        default:
          return;
      }
    }

    // G·ª≠i duration ƒë·∫øn pin ri√™ng (V11 ho·∫∑c V12)
    function sendDuration(buttonId, duration) {
      const pinIndex = pinMap[buttonId + 'Duration'];  // irrigationDuration ho·∫∑c fertilizerDuration
      if (pinIndex !== undefined && isConfigured) {
        const config = actionConfigs[pinIndex];
        if (config) {
          eraWidget.triggerAction(config.action, null, { value: duration });  // Ch·ªâ g·ª≠i gi√° tr·ªã duration (float/int)
        }
      }
    }

    // ƒêi·ªÅu khi·ªÉn (trigger action th·∫≠t) - Ch·ªâ g·ª≠i 0/1 cho control, duration g·ª≠i ri√™ng qua pin
    function controlButton(buttonId, state, duration = null) {
      // Lu√¥n c·∫≠p nh·∫≠t UI tr∆∞·ªõc
      updateButtonState(buttonId, state);

      // ƒê·ªëi v·ªõi mode switch: G·ª≠i action ch·ªâ khi chuy·ªÉn sang manual (state=true) v√† configured
      if ((buttonId === 'irrigation' || buttonId === 'fertilizer') && state && isConfigured) {
        const pinIndex = pinMap[buttonId];
        const config = actionConfigs[pinIndex];
        if (config) {
          eraWidget.triggerAction(config.action, null, { value: 1 });  // Ch·ªâ g·ª≠i 1 (manual)
        }
      } else if ((buttonId === 'irrigation' || buttonId === 'fertilizer') && !state) {
        // Auto mode: Kh√¥ng g·ª≠i action, ch·ªâ c·∫≠p nh·∫≠t UI (ƒë√£ l√†m ·ªü tr√™n)
      } else if (!isConfigured && (buttonId === 'irrigation' || buttonId === 'fertilizer')) {
        alert('Thi·∫øt b·ªã ch∆∞a s·∫µn s√†ng! Chuy·ªÉn ch·∫ø ƒë·ªô local.');
      }

      // X·ª≠ l√Ω indicator v√† g·ª≠i control cho irrigate/fertilize - Ch·ªâ g·ª≠i 0/1, duration ƒë√£ g·ª≠i ri√™ng
      if (buttonId === 'irrigate' && state) {
        setIndicator("status-irrigation", true);
        if (isConfigured) {
          const pinIndex = pinMap['irrigate'];
          const config = actionConfigs[pinIndex];
          if (config) {
            eraWidget.triggerAction(config.action, null, { value: 1 });  // Ch·ªâ g·ª≠i 1 (start), duration t·ª´ V11
          }
        }
        setTimeout(() => {
          controlButton('irrigate', false);
          setIndicator("status-irrigation", false);
        }, irrigationDuration * 1000);  // S·ª≠ d·ª•ng local duration
      } else if (buttonId === 'irrigate' && !state) {
        if (isConfigured) {
          const pinIndex = pinMap['irrigate'];
          const config = actionConfigs[pinIndex];
          if (config) {
            eraWidget.triggerAction(config.action, null, { value: 0 });  // G·ª≠i 0 (stop)
          }
        }
      } else if (buttonId === 'fertilize' && state) {
        setIndicator("status-fertilizer", true);
        if (isConfigured) {
          const pinIndex = pinMap['fertilize'];
          const config = actionConfigs[pinIndex];
          if (config) {
            eraWidget.triggerAction(config.action, null, { value: 1 });  // Ch·ªâ g·ª≠i 1 (start), duration t·ª´ V12
          }
        }
        setTimeout(() => {
          controlButton('fertilize', false);
          setIndicator("status-fertilizer", false);
        }, fertilizerDuration * 1000);
      } else if (buttonId === 'fertilize' && !state) {
        if (isConfigured) {
          const pinIndex = pinMap['fertilize'];
          const config = actionConfigs[pinIndex];
          if (config) {
            eraWidget.triggerAction(config.action, null, { value: 0 });  // G·ª≠i 0 (stop)
          }
        }
      }
    }

    // Toggle fert
    function toggleFert(key) {
      if (fertilizerMode !== "manual") return;  // Ch·ªâ toggle khi manual
      const current = fertilizers[key];
      if (isConfigured) {
        const pinIndex = pinMap[key];
        const config = actionConfigs[pinIndex];
        if (config) {
          eraWidget.triggerAction(config.action, null, { value: !current ? 1 : 0 });  // G·ª≠i 1 (on) ho·∫∑c 0 (off)
        }
      } else {
        // Local toggle n·∫øu ch∆∞a configured
        fertilizers[key] = !current;
        const el = document.getElementById('btn-' + key);
        if (el) {
          if (!current) {
            el.classList.add('bg-green-500', 'text-white');
          } else {
            el.classList.remove('bg-green-500', 'text-white');
          }
        }
      }
      updateButtonState(key, !current);  // C·∫≠p nh·∫≠t UI
    }

    // Init E-Ra nh∆∞ m·∫´u
    eraWidget.init({
      onConfiguration: (configuration) => {
        console.log('E-Ra Configuration received:', configuration);
        
        // Map realtime_configs (V0-V3)
        if (configuration.realtime_configs) {
          configuration.realtime_configs.slice(0, 4).forEach((config, index) => {
            realtimeConfigs[index] = config;
          });
        }

        // Map actions (V4-V12: 9 pins)
        if (configuration.actions) {
          configuration.actions.slice(0, 9).forEach((config, index) => {
            actionConfigs[index] = config;
          });
        }

        isConfigured = true;
        // Kh·ªüi t·∫°o UI v·ªõi mode m·∫∑c ƒë·ªãnh auto (nh∆∞ c≈©)
        updateButtonState('irrigation', false);  // auto
        updateButtonState('fertilizer', false);  // auto
        // G·ª≠i duration m·∫∑c ƒë·ªãnh ƒë·∫øn pin ri√™ng
        sendDuration('irrigation', irrigationDuration);
        sendDuration('fertilizer', fertilizerDuration);
        setIndicator("status-connection", true);
        setIndicator("status-power", true);
      },
      onValues: (values) => {
        realtimeConfigs.forEach((config, index) => {
          if (config && values[config.id]) {
            updateSensorDisplay(index, values[config.id].value);
          }
        });
        // Ki·ªÉm tra auto logic d·ª±a tr√™n soilMoisture (local nh∆∞ c≈©)
        const soilText = document.getElementById('soilMoisture').textContent;
        const soilValue = parseFloat(soilText);
        if (!isNaN(soilValue) && irrigationMode === "auto" && soilValue < 40) {
          setIndicator("status-irrigation", true);
          setTimeout(() => setIndicator("status-irrigation", false), 10000);  // T∆∞·ªõi 10s m·∫∑c ƒë·ªãnh local
        }
      },
      needRealtimeConfigs: true,
      needActions: true,
      ready: true
    });

    // Kh·ªüi t·∫°o UI m·∫∑c ƒë·ªãnh (switch lu√¥n ho·∫°t ƒë·ªông local)
    updateButtonState('irrigation', false);
    updateButtonState('fertilizer', false);
    setIndicator("status-power", true);

    // Event listeners - Lu√¥n ho·∫°t ƒë·ªông, g·ª≠i action n·∫øu configured
    document.getElementById("irrigation-switch").addEventListener("change", (e) => {
      controlButton('irrigation', e.target.checked);
    });
    document.getElementById("fertilizer-switch").addEventListener("change", (e) => {
      controlButton('fertilizer', e.target.checked);
    });

    ["nitrogen", "phosphorus", "potassium"].forEach(key => {
      document.getElementById("btn-" + key).addEventListener("click", () => toggleFert(key));
    });

    document.getElementById("btn-irrigate").onclick = () => {
      if (irrigationMode !== "manual") return;  // Ch·ªâ khi manual
      controlButton('irrigate', true);
    };

    document.getElementById("btn-fertilize").onclick = () => {
      if (fertilizerMode !== "manual") return;  // Ch·ªâ khi manual
      if (!Object.values(fertilizers).some(v => v)) {
        alert("Ch·ªçn √≠t nh·∫•t 1 lo·∫°i ph√¢n!");
        return;
      }
      controlButton('fertilize', true);
    };

    // Event cho slider: C·∫≠p nh·∫≠t local v√† g·ª≠i ƒë·∫øn pin ri√™ng (V11/V12)
    document.getElementById("irrigation-duration").addEventListener("input", (e) => {
      if (irrigationMode === "manual") {
        irrigationDuration = +e.target.value;
        document.getElementById("irrigation-time").textContent = irrigationDuration;
        sendDuration('irrigation', irrigationDuration);  // G·ª≠i ƒë·∫øn V11
      }
    });

    document.getElementById("fertilizer-duration").addEventListener("input", (e) => {
      if (fertilizerMode === "manual") {
        fertilizerDuration = +e.target.value;
        document.getElementById("fertilizer-time").textContent = fertilizerDuration;
        sendDuration('fertilizer', fertilizerDuration);  // G·ª≠i ƒë·∫øn V12
      }
    });

    // X·ª≠ l√Ω l·ªói
    window.addEventListener('error', (e) => {
      setIndicator("status-connection", false);
      console.error("Error:", e);
    });
  </script>
</body>
</html>